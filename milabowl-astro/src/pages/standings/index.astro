---
import Card from '../../components/core/Card.astro';
import Layout from '../../layouts/Layout.astro';
import game_state from '../../../src/game_state/game_state.json';
import type { MilaResultsDTO } from '../../game_state/gameState.ts';
import StandingsTable from './_components/StandingsTable.tsx';
import StandingsTableMobile from './_components/StandingsTable_Mobile.tsx';
import Link from '../../components/core/Link.astro';
import type { ImageMetadata } from 'astro';
import { getImage } from 'astro:assets';

const milaResults: MilaResultsDTO = game_state;
const overallScore = milaResults.overallScore;

const imgs = Object.values(
  import.meta.glob<{ default: ImageMetadata }>('../../assets/*.webp', {
    eager: true,
  })
);

const optimizedImages = await Promise.all(
  imgs.map(async (img) => {
    const img60Avif = await getImage({
      src: img.default,
      width: 72,
      height: 72,
      format: 'avif',
    });

    const img60Webp = await getImage({
      src: img.default,
      width: 72,
      height: 72,
      format: 'webp',
    });

    return {
      src: img.default.src,
      avif: [`${img60Avif.src} 72w`],
      webp: [`${img60Webp.src} 72w`],
      sizes: '48px',
    };
  })
);

const lastGameWeek = Math.max.apply(
  Math,
  game_state.resultsByWeek.map((r) => r.gameWeek)
);
---

<Layout title="Milabowl - Overall standings" enableViewTransitions>
  <Card title="Standings - Overall">
    <div slot="secondary" class="flex flex-row gap-3">
      <Link href={`/standings/${lastGameWeek}`}>Latest Gameweek</Link>
      {milaResults.isLive && <div class="font-bold">ðŸ”´ Live</div>}
    </div>
    <div class="hidden md:block">
      <StandingsTable
        data={overallScore}
        lastGameWeek={lastGameWeek}
        avatars={optimizedImages}
        client:idle
      />
    </div>
    <div class="block md:hidden">
      <StandingsTableMobile
        data={overallScore}
        lastGameWeek={lastGameWeek}
        avatars={optimizedImages}
        client:idle
      />
    </div>
  </Card>
</Layout>
