---
import RetroLayout from '../layouts/RetroLayout.astro';
import Card from '../components/core/Card.astro';
import Trend from './_components/Trend';
import game_state from '../../src/game_state/game_state.json';
import bomb_state from '../../src/game_state/bomb_state.json';
import type { MilaResultsDTO } from '../game_state/gameState';
import type { BombHistoryState } from '../game_state/bombState';
import type { ResultsForTeams } from './_components/types';
import Link from '../components/core/Link.astro';
import BombState from './_components/BombState.astro';
import type { ImageMetadata } from 'astro';
import { getImage } from 'astro:assets';
import OverviewTable from './_components/OverviewTable';
import LatestBlogEntries from './_components/LatestBlogEntries.astro';
import NewBlogEntry from './_components/NewBlogEntry.astro';

const milaResults: MilaResultsDTO = game_state;
const bombState: BombHistoryState = bomb_state;

const currentGameWeek = Math.max(
  ...milaResults.resultsByWeek.map((r) => r.gameWeek)
);
const currentGameWeekResults =
  milaResults.resultsByWeek.find((week) => week.gameWeek === currentGameWeek)
    ?.results || [];

const latestThreeBombWeeks = Object.entries(bombState.bombHistoryByGameWeek)
  .map(([gw, events]) => ({ gameWeek: Number(gw), events }))
  .sort((a, b) => b.gameWeek - a.gameWeek)
  .slice(0, 3);
const lastThree: BombHistoryState = {
  bombHistoryByGameWeek: Object.fromEntries(
    latestThreeBombWeeks.map((w) => [w.gameWeek, w.events])
  ),
  currentRoundEmojis: bombState.currentRoundEmojis,
  currentState: bombState.currentState,
};

const imgs = Object.values(
  import.meta.glob<{ default: ImageMetadata }>('../assets/*.webp', {
    eager: true,
  })
);

const optimizedImages = await Promise.all(
  imgs.map(async (img) => {
    const img60Avif = await getImage({
      src: img.default,
      width: 72,
      height: 72,
      format: 'avif',
    });

    const img60Webp = await getImage({
      src: img.default,
      width: 72,
      height: 72,
      format: 'webp',
    });

    return {
      src: img.default.src,
      avif: [`${img60Avif.src} 72w`],
      webp: [`${img60Webp.src} 72w`],
      sizes: '48px',
    };
  })
);

const resultsByUser = milaResults.resultsByUser;

const lastFiveWeeksByTeam: ResultsForTeams[] = resultsByUser.map((team) => ({
  teamName: team.teamName,
  results: team.results.slice(-5).map((result) => ({
    gameWeek: result.gameWeek,
    milaRank: result.milaRank,
    cumulativeAverageMilaPoints: result.cumulativeAverageMilaPoints,
    totalCumulativeAverageMilaPoints: result.totalCumulativeAverageMilaPoints,
  })),
}));
---

<RetroLayout
  title="Milabowl - Dashboard"
  description="Milabowl is a custom Fantasy Premier League dashboard with unique rules, live standings, and chaotic twists. Track your team's progress and enjoy a fresh take on FPL!"
  enableViewTransitions
>
  <main>
    <NewBlogEntry />
    <div class="flex flex-col gap-4 lg:grid lg:grid-cols-12">
      <div class="lg:col-span-5">
        <Card title="Standings">
          <div slot="secondary" class="flex flex-row gap-3">
            {milaResults.isLive && <div class="font-bold">ðŸ”´ Live</div>}
          </div>

          <OverviewTable
            avatars={optimizedImages}
            data={milaResults.overallScore}
            currentGameWeekResults={currentGameWeekResults}
            bombState={bombState.currentRoundEmojis}
            client:idle
          />
        </Card>
      </div>

      <div class="lg:col-span-7">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12 grid gap-4 md:col-span-6">
            <Card title="Bomb">
              <div slot="secondary">
                <Link href="/bomb_history">View history</Link>
              </div>
              <div>
                <BombState bombState={lastThree} />
              </div>
            </Card>
          </div>
          <div class="col-span-12 md:col-span-6">
            <Card title="Latest Blogs">
              <div slot="secondary">
                <Link href="/blog">All blogs</Link>
              </div>
              <div>
                <LatestBlogEntries />
              </div>
            </Card>
          </div>
          <div class="col-span-12">
            <Card title="Trend">
              <Trend teams={lastFiveWeeksByTeam} client:load />
            </Card>
          </div>
        </div>
      </div>
    </div>
  </main>
</RetroLayout>
